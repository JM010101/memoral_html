<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorial Admin - Add & Edit Memorials</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .photo-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--bg-light);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .photo-upload:hover {
            border-color: var(--primary-color);
            background: white;
        }
        
        .photo-upload.dragover {
            border-color: var(--primary-color);
            background: #e6f2ff;
        }
        
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .photo-item .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .photo-item .alt-text {
            padding: 0.5rem;
            font-size: 0.85rem;
            background: white;
        }
        
        .photo-item .alt-text input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 0.85rem;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .btn-primary {
            flex: 1;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            padding: 1rem 2rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .existing-memorials {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
        }
        
        .memorial-list-item {
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .memorial-list-item h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .memorial-list-item p {
            margin: 0.25rem 0 0 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .memorial-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-edit,
        .btn-delete {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-edit {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .success-message,
        .error-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .helper-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="logo">In Memory</a>
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="memorials.html">Memorials</a></li>
                    <li><a href="admin.html">Admin</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <div class="admin-container">
            <div class="admin-header">
                <h1>Memorial Admin Panel</h1>
                <p>Add or edit memorial pages - No coding required!</p>
            </div>

            <div id="messageContainer"></div>

            <form id="memorialForm">
                <div class="form-group">
                    <label for="memorialId">Memorial ID (auto-generated)</label>
                    <input type="text" id="memorialId" readonly>
                    <p class="helper-text">This is automatically created</p>
                </div>

                <div class="form-group">
                    <label for="name">Full Name *</label>
                    <input type="text" id="name" required placeholder="John Smith">
                </div>

                <div class="form-group">
                    <label for="birthDate">Birth Date *</label>
                    <input type="date" id="birthDate" required>
                    <p class="helper-text">Select the birth date</p>
                </div>

                <div class="form-group">
                    <label for="deathDate">Death Date *</label>
                    <input type="date" id="deathDate" required>
                    <p class="helper-text">Select the death date</p>
                </div>

                <div class="form-group">
                    <label for="tribute">Memorial Tribute *</label>
                    <textarea id="tribute" required placeholder="Write a beautiful tribute here...&#10;&#10;Press Enter twice to start a new paragraph."></textarea>
                    <p class="helper-text">Write the memorial tribute. Press Enter twice for new paragraphs.</p>
                </div>

                <div class="form-group">
                    <label>Memorial Photos (1-6 photos)</label>
                    <div class="photo-upload" id="photoUpload">
                        <p>ðŸ“· Drag & Drop photos here or click to select</p>
                        <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                            Supported: JPG, PNG, AVIF â€¢ Max size: 5MB per photo
                        </p>
                        <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                    </div>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button type="submit" class="btn-primary" id="submitBtn">Add Memorial</button>
                </div>
            </form>

            <div class="existing-memorials">
                <h2>Existing Memorials</h2>
                <div id="memorialsList"></div>
            </div>
        </div>
    </main>

    <script>
        let memorialsData = [];
        let currentPhotos = [];
        let editingId = null;

        // Load existing memorials
        async function loadMemorials() {
            try {
                const response = await fetch('data/memorials.json');
                const data = await response.json();
                // Handle both formats: {memorials: [...]} or [...]
                memorialsData = data.memorials || data;
                displayMemorialsList();
                generateNextId();
            } catch (error) {
                console.error('Error loading memorials:', error);
                showMessage('Error loading memorials. Please refresh the page.', 'error');
            }
        }

        // Display list of existing memorials
        function displayMemorialsList() {
            const container = document.getElementById('memorialsList');
            if (memorialsData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No memorials yet. Add your first one above!</p>';
                return;
            }

            container.innerHTML = memorialsData.map(memorial => `
                <div class="memorial-list-item">
                    <div>
                        <h3>${memorial.name}</h3>
                        <p>${formatDate(memorial.birthDate)} - ${formatDate(memorial.deathDate)}</p>
                    </div>
                    <div class="memorial-actions">
                        <button class="btn-edit" onclick="editMemorial('${memorial.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteMemorial('${memorial.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Generate next memorial ID
        function generateNextId() {
            if (editingId) return;
            const maxId = memorialsData.reduce((max, m) => {
                const num = parseInt(m.id.replace('memorial-', ''));
                return num > max ? num : max;
            }, 0);
            document.getElementById('memorialId').value = `memorial-${maxId + 1}`;
        }

        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.getFullYear();
        }

        // Photo upload handling
        const photoUpload = document.getElementById('photoUpload');
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');

        photoUpload.addEventListener('click', () => photoInput.click());
        photoUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            photoUpload.classList.add('dragover');
        });
        photoUpload.addEventListener('dragleave', () => {
            photoUpload.classList.remove('dragover');
        });
        photoUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            photoUpload.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        photoInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (currentPhotos.length + files.length > 6) {
                showMessage('Maximum 6 photos allowed per memorial', 'error');
                return;
            }

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showMessage('Please upload only image files', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showMessage(`${file.name} is too large. Max size is 5MB`, 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoObj = {
                        file: file,
                        dataUrl: e.target.result,
                        alt: `Photo of ${document.getElementById('name').value || 'memorial'}`
                    };
                    currentPhotos.push(photoObj);
                    displayPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayPhotos() {
            photoPreview.innerHTML = currentPhotos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.dataUrl}" alt="Preview ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})" type="button">Ã—</button>
                    <div class="alt-text">
                        <input type="text" 
                               placeholder="Describe this photo..." 
                               value="${photo.alt}"
                               onchange="updateAltText(${index}, this.value)">
                    </div>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            displayPhotos();
        }

        function updateAltText(index, value) {
            currentPhotos[index].alt = value;
        }

        let adminPassword = '';

        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password) {
                adminPassword = password;
                document.getElementById('loginSection').style.display = 'none';
                showMessage('Logged in! You can now add/edit memorials.', 'success');
            }
        }

        // Form submission with serverless backend
        document.getElementById('memorialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!adminPassword) {
                showMessage('Please enter the admin password first', 'error');
                document.getElementById('loginSection').style.display = 'block';
                return;
            }
            
            if (currentPhotos.length === 0) {
                showMessage('Please add at least one photo', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading images and saving...';

            try {
                // Upload photos to GitHub via serverless function
                const photos = await Promise.all(currentPhotos.map(async (photo, index) => {
                    const filename = `${document.getElementById('name').value.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}-${index + 1}.${photo.file.name.split('.').pop()}`;
                    
                    // Convert file to base64
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(photo.file);
                    });

                    // Upload to GitHub via serverless function
                    const uploadResponse = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: adminPassword,
                            filename: filename,
                            content: base64
                        })
                    });

                    if (!uploadResponse.ok) {
                        const error = await uploadResponse.json();
                        throw new Error(error.error || 'Failed to upload image');
                    }

                    const uploadData = await uploadResponse.json();
                    
                    return {
                        url: uploadData.url,
                        alt: photo.alt || `Photo of ${document.getElementById('name').value}`
                    };
                }));

                submitBtn.textContent = 'Saving memorial...';

                const memorial = {
                    id: document.getElementById('memorialId').value,
                    name: document.getElementById('name').value,
                    birthDate: document.getElementById('birthDate').value,
                    deathDate: document.getElementById('deathDate').value,
                    tribute: document.getElementById('tribute').value,
                    photos: photos
                };

                if (editingId) {
                    const index = memorialsData.findIndex(m => m.id === editingId);
                    memorialsData[index] = memorial;
                } else {
                    memorialsData.push(memorial);
                }

                // Save to GitHub via serverless function
                const saveResponse = await fetch('/api/save-memorial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        memorials: memorialsData
                    })
                });

                if (!saveResponse.ok) {
                    const error = await saveResponse.json();
                    throw new Error(error.error || 'Failed to save memorial');
                }

                showMessage('Memorial saved successfully! Site will update in 1-2 minutes.', 'success');
                
                displayMemorialsList();
                clearForm();
                
            } catch (error) {
                console.error('Error saving memorial:', error);
                showMessage(`Error: ${error.message}. Please try again.`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editingId ? 'Update Memorial' : 'Add Memorial';
            }
        });

        async function downloadJSON() {
            // Backup function - save to GitHub via API
            if (!adminPassword) {
                showMessage('Please enter the admin password first', 'error');
                document.getElementById('loginSection').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/save-memorial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        memorials: memorialsData
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save');
                }

                showMessage('Memorials saved to GitHub! Site will update in 1-2 minutes.', 'success');
            } catch (error) {
                showMessage('Error saving memorials: ' + error.message, 'error');
            }
        }

        function clearForm() {
            document.getElementById('memorialForm').reset();
            currentPhotos = [];
            editingId = null;
            displayPhotos();
            generateNextId();
            document.getElementById('submitBtn').textContent = 'Add Memorial';
        }

        function editMemorial(id) {
            const memorial = memorialsData.find(m => m.id === id);
            if (!memorial) return;

            editingId = id;
            document.getElementById('memorialId').value = memorial.id;
            document.getElementById('name').value = memorial.name;
            document.getElementById('birthDate').value = memorial.birthDate;
            document.getElementById('deathDate').value = memorial.deathDate;
            document.getElementById('tribute').value = memorial.tribute.replace(/\\n/g, '\n');
            
            // Can't easily load existing photos in browser
            currentPhotos = [];
            showMessage('Editing memorial. Re-upload photos if you want to change them.', 'success');
            
            document.getElementById('submitBtn').textContent = 'Update Memorial';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteMemorial(id) {
            if (!confirm('Are you sure you want to delete this memorial? This cannot be undone.')) {
                return;
            }

            memorialsData = memorialsData.filter(m => m.id !== id);
            downloadJSON();
            displayMemorialsList();
            showMessage('Memorial deleted. Download the new memorials.json file.', 'success');
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialize
        loadMemorials();
    </script>
</body>
</html>
